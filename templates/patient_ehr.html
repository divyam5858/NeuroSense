<!DOCTYPE html>
<html lang="en">

<head>
    <title>My EHR - NeuroSense</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <style>
        body { margin:0; font-family:Arial; background:#f8fafc; }

        .navbar { display:flex; justify-content:space-between; align-items:center;
            padding:14px 35px; background:white; border-bottom:1px solid #e5e7eb; }
        .nav-left { display:flex; align-items:center; gap:10px; }
        .nav-logo { width:35px; }
        .nav-title { font-size:22px; font-weight:bold; }

        .nav-menu a {
            margin:0 18px; text-decoration:none; color:#4b5563;
            font-weight:500; padding-bottom:6px;
        }
        .nav-menu a.active {
            color:#2563eb; border-bottom:3px solid #2563eb;
        }

        .container { padding:40px 60px; }

        .ehr-header { font-size:32px; font-weight:bold; }
        .ehr-subtitle { color:#6b7280; margin-bottom:20px; }

        .patient-box {
            background:white; padding:25px; border-radius:12px;
            border:1px solid #e5e7eb; margin-bottom:30px;
        }

        .row { display:flex; justify-content:space-between; margin-top:10px; }
        .label { color:#6b7280; font-size:14px; }
        .value { font-size:16px; font-weight:bold; }

        .tabs { display:flex; border-bottom:1px solid #e5e7eb; margin-bottom:20px; }
        .tab {
            padding:12px 18px; cursor:pointer;
            font-weight:500; color:#4b5563;
            border-radius:10px 10px 0 0;
        }
        .tab.active { background:#2563eb; color:white; }

        .content-box {
            background:white; padding:25px;
            border-radius:12px; border:1px solid #e5e7eb;
        }

        .record-item {
            margin-bottom:20px;
        }

        .record-title {
            font-weight:bold;
            margin-bottom:5px;
        }

        .record-date {
            font-size:13px;
            color:#6b7280;
            margin-bottom:8px;
        }

        .download-btn {
            float:right;
            background:#2563eb;
            padding:10px 22px;
            color:white;
            border:none;
            border-radius:10px;
            cursor:pointer;
        }
        .download-btn:hover { background:#1e40af; }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #dc2626;
            padding: 14px 20px;
            color: white;
            border-radius: 8px;
            display: none;
        }
    </style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
    <div class="nav-left">
        <img src="{{ url_for('static', filename='logo.png') }}" class="nav-logo">
        <span class="nav-title">NeuroSense</span>
    </div>

    <div class="nav-menu">
        <a href="{{ url_for('patient_dashboard') }}"
           class="{{ 'active' if active_page=='dashboard' else '' }}">
           Dashboard
        </a>

        <a href="assessment"
           class="{{ 'active' if active_page=='assessment' else '' }}">
           Start Assessment
        </a>

        <a href="timeline" 
           class="{{ 'active' if active_page=='timeline' else '' }}">
           Health Timeline
        </a>

        <a href="ehr"
           class="{{ 'active' if active_page=='ehr' else '' }}">
           My EHR
        </a>

        <a href="patient_profile"
           class="{{ 'active' if active_page=='profile' else '' }}">
           My Profile
        </a>
    </div>
</div>

<!-- PAGE CONTENT -->
<div class="container">

    <div class="ehr-header">Electronic Health Records</div>
    <div class="ehr-subtitle">Your complete medical information</div>

    <button class="download-btn" onclick="downloadEHR()">Download Full EHR</button>

    <div id="toast" class="toast"></div>

    <!-- PATIENT INFO -->
    <div class="patient-box">
        <div style="font-size:20px; font-weight:bold; margin-bottom:10px;">
            Patient Information
        </div>

        <div class="row">
            <div>
                <div class="label">Name</div>
                <div class="value">{{ info.full_name }}</div>
            </div>
            <div>
                <div class="label">Age</div>
                <div class="value">{{ info.age }} years</div>
            </div>
            <div>
                <div class="label">Gender</div>
                <div class="value">{{ info.gender }}</div>
            </div>
        </div>

        <div class="row">
            <div>
                <div class="label">Blood Type</div>
                <div class="value">{{ info.blood_type }}</div>
            </div>
            <div>
                <div class="label">Email</div>
                <div class="value">{{ info.email }}</div>
            </div>
            <div>
                <div class="label">Phone</div>
                <div class="value">{{ info.phone }}</div>
            </div>
        </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <div class="tab">Medications</div>
        <div class="tab">Allergies</div>
        <div class="tab">Medical History</div>
        <div class="tab active">Assessments</div>
    </div>

    <!-- CONTENT -->
    <div class="content-box">

        {% if assessments and assessments|length > 0 %}
            {% for a in assessments %}
               {% set d = a.diag %}

                <div class="record-item">
                    <div class="record-title">
                        Primary Diagnosis: {{ d.primary_diagnosis }}
                    </div>
                    <div class="record-date">
                        {{ a.created_at.strftime('%d %b %Y, %I:%M %p') }}
                    </div>
                    <p><b>Confidence:</b> {{ d.diagnosis_confidence }}</p>
                    <p><b>Secondary:</b> {{ d.secondary_diagnoses | join(', ') }}</p>
                    <p><b>Recommendations:</b></p>
                    <ul>
                        {% for r in d.recommendations %}
                            <li>{{ r }}</li>
                        {% endfor %}
                    </ul>
                </div>
                <hr>
            {% endfor %}
        {% else %}
            <p>No medical records found.</p>
        {% endif %}

    </div>

</div>

<script>
function showToast(message) {
    const toast = document.getElementById("toast");
    toast.innerText = message;
    toast.style.display = "block";
    setTimeout(() => { toast.style.display = "none"; }, 3000);
}

function downloadEHR() {
    fetch("ehr_download")
        .then(response => {
            if (!response.ok) {
                showToast("Failed to download EHR. Please try again.");
                return;
            }
            return response.blob();
        })
        .then(blob => {
            if (!blob) return;
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "EHR_Report.pdf";
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(() => {
            showToast("Error downloading EHR.");
        });
}
</script>

</body>
</html>
